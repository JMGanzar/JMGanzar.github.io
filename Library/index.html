<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Ultimate Manga Library</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --accent: #ff9ff3;
            --bg-dark: #0a0e27;
            --bg-card: rgba(255, 255, 255, 0.05);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: #fff;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 159, 243, 0.1) 0%, transparent 50%);
            animation: backgroundShift 20s ease infinite;
            z-index: -1;
        }
        
        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(78, 205, 196, 0.2));
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 900;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #ff9ff3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card h3 {
            font-size: 2em;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-card p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-tab {
            padding: 12px 24px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            border-color: transparent;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .toolbar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #ff6b6b;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }
        
        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .input-group select option {
            background: #1a1f3a;
            color: #fff;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 28px;
            border-radius: 15px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .btn-primary { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-secondary { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-accent { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-ai { background: linear-gradient(135deg, #ec4899, #8b5cf6); }
        
        .manga-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
        }
        
        .manga-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s;
            position: relative;
        }
        
        .manga-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
        }
        
        .manga-card img {
            width: 100%;
            height: 320px;
            object-fit: cover;
        }
        
        .manga-info {
            padding: 18px;
        }
        
        .manga-title {
            color: #fff;
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 1.1em;
            line-height: 1.3;
            height: 2.6em;
            overflow: hidden;
        }
        
        .manga-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95em;
            margin-bottom: 12px;
        }
        
        .rating-stars {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .star {
            cursor: pointer;
            font-size: 1.5em;
            transition: all 0.2s;
        }
        
        .star.filled {
            color: #fbbf24;
        }
        
        .star.empty {
            color: rgba(255, 255, 255, 0.2);
        }
        
        .manga-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .tag {
            background: rgba(255, 107, 107, 0.3);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.75em;
            border: 1px solid rgba(255, 107, 107, 0.5);
        }
        
        .manga-actions {
            display: flex;
            gap: 8px;
        }
        
        .manga-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: all 0.3s;
        }
        
        .btn-read { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-edit { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-delete { background: linear-gradient(135deg, #ef4444, #dc2626); }
        
        .badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 2;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1f3a, #2d3561);
            padding: 35px;
            border-radius: 25px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
        }
        
        .ai-suggestion {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(139, 92, 246, 0.2));
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(236, 72, 153, 0.3);
            margin-bottom: 20px;
        }
        
        .ai-suggestion h3 {
            color: #ec4899;
            margin-bottom: 10px;
        }
        
        .recommendation-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            transition: width 0.3s;
        }
        
        input[type="file"] {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .manga-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° ULTIMATE MANGA LIBRARY ‚ö°</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalMangas">0</h3>
                    <p>üìö Total Mangas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalChapters">0</h3>
                    <p>üìñ Cap√≠tulos Le√≠dos</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedMangas">0</h3>
                    <p>‚úÖ Completados</p>
                </div>
                <div class="stat-card">
                    <h3 id="readingStreak">0</h3>
                    <p>üî• Racha (d√≠as)</p>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <div id="syncStatus" class="sync-status" onclick="checkGitHubSetup()">
                    üîÑ Iniciando sincronizaci√≥n...
                </div>
                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9em;" onclick="showSyncInfo()">
                    ‚ÑπÔ∏è Info
                </button>
                <button class="btn btn-accent" style="padding: 8px 16px; font-size: 0.9em;" onclick="manualSync()">
                    üîÑ Sync Manual
                </button>
                <button class="btn btn-warning" style="padding: 8px 16px; font-size: 0.9em;" onclick="exportToMihon()">
                    üì± Exportar a Mihon
                </button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('biblioteca')">üìö Biblioteca</button>
            <button class="nav-tab" onclick="switchTab('estadisticas')">üìä Estad√≠sticas</button>
            <button class="nav-tab" onclick="switchTab('ia')">ü§ñ Asistente IA</button>
            <button class="nav-tab" onclick="switchTab('descubrir')">üîç Descubrir</button>
            <button class="nav-tab" onclick="switchTab('colecciones')">üè∑Ô∏è Colecciones</button>
        </div>
        
        <!-- SECCI√ìN BIBLIOTECA -->
        <div id="biblioteca" class="section active">
            <div class="toolbar">
                <div class="filters">
                    <div class="input-group">
                        <input type="text" id="searchInput" placeholder="üîç Buscar...">
                    </div>
                    <div class="input-group">
                        <select id="filterDemografia">
                            <option value="">üìö Todas</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <select id="filterStatus">
                            <option value="all">Todos</option>
                            <option value="reading">üìñ Leyendo</option>
                            <option value="completed">‚úÖ Completados</option>
                            <option value="paused">‚è∏Ô∏è En pausa</option>
                            <option value="dropped">‚ùå Abandonados</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <select id="filterRating">
                            <option value="all">‚≠ê Todas</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-ai" onclick="suggestRandomManga()">üé≤ ¬øQu√© leo hoy?</button>
                    <button class="btn btn-primary" onclick="quickReadMode()">‚ö° Lectura R√°pida</button>
                    <button class="btn btn-primary" onclick="openAddModal()">‚ûï A√±adir</button>
                    <label class="btn btn-secondary">
                        üì§ Importar JSON
                        <input type="file" id="importFile" accept=".json" onchange="importJSON(event)">
                    </label>
                    <button class="btn btn-accent" onclick="exportJSON()">üì• Exportar JSON</button>
                    <button class="btn btn-warning" onclick="importFromMihon()">üì± Importar Mihon</button>
                    <button class="btn btn-warning" onclick="removeDuplicates()">üîÑ Limpiar</button>
                    <button class="btn btn-secondary" onclick="viewReadingHistory()">üìñ Historial</button>
                    <button class="btn btn-ai" onclick="updateAllCovers()">üñºÔ∏è Actualizar Portadas</button>
                    <button class="btn btn-accent" onclick="generateLibrarySummary()">ü§ñ Resumen IA</button>
                </div>
            </div>
            
            <div id="mangaGrid" class="manga-grid"></div>
        </div>
        
        <!-- SECCI√ìN ESTAD√çSTICAS -->
        <div id="estadisticas" class="section">
            <div class="toolbar">
                <h2 style="margin-bottom: 20px;">üìä Tus Estad√≠sticas de Lectura</h2>
                
                <div class="chart-container">
                    <h3>üìö Mangas por Demograf√≠a</h3>
                    <div id="demografiaChart"></div>
                </div>
                
                <div class="chart-container">
                    <h3>üìñ Progreso de Lectura</h3>
                    <div id="progressChart"></div>
                </div>
                
                <div class="chart-container">
                    <h3>üèÜ Top 10 M√°s Le√≠dos</h3>
                    <div id="topMangasChart"></div>
                </div>
            </div>
        </div>
        
        <!-- SECCI√ìN IA -->
        <div id="ia" class="section">
            <div class="toolbar">
                <h2 style="margin-bottom: 20px;">ü§ñ Asistente IA Powered</h2>
                
                <div class="ai-suggestion">
                    <h3>üí° Recomendaci√≥n Inteligente</h3>
                    <p id="aiRecommendation">Cargando sugerencias basadas en tu biblioteca...</p>
                </div>
                
                <div class="form-group">
                    <label>üí¨ Preg√∫ntale a la IA sobre tu biblioteca</label>
                    <textarea id="aiQuery" placeholder="Ej: ¬øQu√© manga deber√≠a leer si me gust√≥ One Piece?"></textarea>
                    <button class="btn btn-ai" onclick="askAI()" style="width: 100%; margin-top: 10px;">
                        ü§ñ Preguntar a la IA
                    </button>
                </div>
                
                <div id="aiResponse" class="ai-suggestion" style="display: none;">
                    <h3>ü§ñ Respuesta de la IA</h3>
                    <p id="aiResponseText"></p>
                </div>
                
                <div class="chart-container">
                    <h3>üéØ An√°lisis de Preferencias</h3>
                    <div id="preferencesAnalysis"></div>
                </div>
            </div>
        </div>
        
        <!-- SECCI√ìN DESCUBRIR -->
        <div id="descubrir" class="section">
            <div class="toolbar">
                <h2 style="margin-bottom: 20px;">üîç Descubre Nuevos Mangas</h2>
                
                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="searchTrending()">üî• Trending Ahora</button>
                    <button class="btn btn-secondary" onclick="searchPopular()">‚≠ê M√°s Populares</button>
                    <button class="btn btn-accent" onclick="searchRecommended()">üí° Recomendados</button>
                </div>
                
                <div class="form-group">
                    <input type="text" id="searchNewManga" placeholder="üîç Buscar mangas nuevos...">
                    <button class="btn btn-primary" onclick="searchNewMangas()" style="width: 100%; margin-top: 10px;">
                        Buscar
                    </button>
                </div>
                
                <div id="discoverGrid" class="manga-grid"></div>
            </div>
        </div>
        
        <!-- SECCI√ìN COLECCIONES -->
        <div id="colecciones" class="section">
            <div class="toolbar">
                <h2 style="margin-bottom: 20px;">üè∑Ô∏è Mis Colecciones</h2>
                
                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="createCollection()">‚ûï Nueva Colecci√≥n</button>
                </div>
                
                <div id="collectionsGrid"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal A√±adir -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï A√±adir Manga</h2>
                <button class="close-btn" onclick="closeAddModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>üîó URL del Manga</label>
                <input type="text" id="newMangaUrl">
            </div>
            <div class="form-group">
                <label>üìñ Cap√≠tulo Actual</label>
                <input type="number" id="newMangaChapter" value="0">
            </div>
            <button class="btn btn-primary" onclick="addManga()" style="width: 100%;">
                <span id="addBtnText">‚ûï A√±adir</span>
            </button>
        </div>
    </div>
    
    <!-- Modal Editar -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Manga</h2>
                <button class="close-btn" onclick="closeEditModal()">√ó</button>
            </div>
            
            <div class="form-group">
                <label>üìù T√≠tulo</label>
                <input type="text" id="editTitle">
            </div>
            
            <div class="form-group">
                <label>‚≠ê Tu Calificaci√≥n</label>
                <div class="rating-stars" id="editRatingStars"></div>
            </div>
            
            <div class="form-group">
                <label>üìñ Cap√≠tulo Actual</label>
                <input type="number" id="editChapter">
            </div>
            
            <div class="form-group">
                <label>üìö Cap√≠tulos Totales</label>
                <input type="number" id="editTotalChapter">
            </div>
            
            <div class="form-group">
                <label>üìä Estado</label>
                <select id="editStatus">
                    <option value="reading">üìñ Leyendo</option>
                    <option value="completed">‚úÖ Completado</option>
                    <option value="paused">‚è∏Ô∏è En pausa</option>
                    <option value="dropped">‚ùå Abandonado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>üé≠ Demograf√≠a</label>
                <select id="editDemografia">
                    <option value="">Seleccionar</option>
                    <option value="Shounen">Shounen</option>
                    <option value="Shoujo">Shoujo</option>
                    <option value="Seinen">Seinen</option>
                    <option value="Josei">Josei</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>üè∑Ô∏è Tags (separados por comas)</label>
                <input type="text" id="editTags" placeholder="Favorito, Acci√≥n, Aventura">
            </div>
            
            <div class="form-group">
                <label>üìù Notas Personales</label>
                <textarea id="editNotes" placeholder="Tus pensamientos sobre este manga..."></textarea>
            </div>
            
            <div class="form-group">
                <label>üñºÔ∏è URL Portada</label>
                <input type="text" id="editCover">
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="editMihon">
                <label>üì± En Mihon</label>
            </div>
            
            <button class="btn btn-secondary" onclick="saveEdit()" style="width: 100%; margin-top: 20px;">
                üíæ Guardar
            </button>
        </div>
    </div>

    <script>
        let mangas = [];
        let currentEditIndex = -1;
        let collections = [];
        let readingHistory = [];
        const JIKAN_API = 'https://api.jikan.moe/v4';
        
        // SINCRONIZACI√ìN EN LA NUBE CON GITHUB GIST
        let syncInterval = null;
        let gistId = localStorage.getItem('gist-id') || null;
        let githubToken = localStorage.getItem('github-token') || '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';
        
        // Guardar el token si no existe
        if (!localStorage.getItem('github-token')) {
            localStorage.setItem('github-token', githubToken);
        }
        
        window.onload = async function() {
            await checkGitHubSetup();
            await syncFromCloud();
            updateAllStats();
            generateAIRecommendations();
            switchTab('biblioteca');
            
            // Auto-sync cada 2 minutos
            syncInterval = setInterval(syncFromCloud, 120000);
            
            // Auto-backup local cada 30 minutos
            setInterval(createAutoBackup, 1800000);
            createAutoBackup(); // Crear backup inicial
        };
        
        async function checkGitHubSetup() {
            if (!gistId) {
                updateSyncStatus('‚öôÔ∏è Creando tu biblioteca en la nube...', 'info');
                await createInitialGist();
            } else {
                await syncFromCloud();
            }
        }
        
        async function manualSync() {
            updateSyncStatus('üîÑ Sincronizando manualmente...', 'info');
            await syncFromCloud();
            alert('‚úÖ Sincronizaci√≥n completada');
        }
        
        // EXPORTAR FORMATO MIHON (Tachiyomi backup compatible)
        function exportToMihon() {
            if (mangas.length === 0) {
                alert('No hay mangas para exportar');
                return;
            }
            
            // Formato compatible con Tachiyomi/Mihon backup
            const mihonBackup = {
                backupManga: mangas.map(manga => ({
                    source: 0, // Source gen√©rica
                    url: manga.url || '',
                    title: manga.titulo || '',
                    artist: '',
                    author: '',
                    description: manga.notes || '',
                    genre: [manga.demografia || 'Unknown'],
                    status: getMihonStatus(manga.status),
                    thumbnailUrl: manga.cover_image || '',
                    dateAdded: new Date(manga.fecha_agregado).getTime(),
                    viewer: 0,
                    chapterFlags: 0,
                    coverLastModified: Date.now(),
                    favorite: true,
                    lastModifiedAt: Date.now(),
                    chapters: [{
                        url: manga.url || '',
                        name: `Chapter ${manga.capitulo_actual || 1}`,
                        scanlator: '',
                        read: false,
                        bookmark: false,
                        lastPageRead: 0,
                        dateFetch: Date.now(),
                        dateUpload: Date.now(),
                        chapterNumber: manga.capitulo_actual || 0,
                        sourceOrder: 0
                    }],
                    categories: manga.tags || [],
                    tracking: []
                })),
                backupCategories: collections.map(col => ({
                    name: col.name,
                    order: 0,
                    flags: 0
                })),
                backupSources: []
            };
            
            const blob = new Blob([JSON.stringify(mihonBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tachiyomi_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup para Mihon/Tachiyomi exportado\n\nPara importar:\n1. Abre Mihon\n2. Ajustes ‚Üí Copias de seguridad\n3. Restaurar copia de seguridad\n4. Selecciona el archivo');
        }
        
        function getMihonStatus(status) {
            const statusMap = {
                'reading': 1,
                'completed': 2,
                'paused': 3,
                'dropped': 5
            };
            return statusMap[status] || 0;
        }
        
        // IMPORTAR DESDE MIHON
        async function importFromMihon() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (backup.backupManga) {
                            const imported = backup.backupManga.map(m => ({
                                url: m.url || '',
                                manga_id: Date.now().toString() + Math.random(),
                                cover_image: m.thumbnailUrl || '',
                                titulo: m.title || 'Sin t√≠tulo',
                                titulo_display: m.title || 'Sin t√≠tulo',
                                demografia: m.genre?.[0] || '',
                                capitulo_actual: m.chapters?.[0]?.chapterNumber || 0,
                                capitulo_total: 0,
                                status: getStatusFromMihon(m.status),
                                rating: 0,
                                tags: m.categories || [],
                                notes: m.description || '',
                                en_mihon: true,
                                fecha_agregado: new Date(m.dateAdded).toISOString()
                            }));
                            
                            mangas = [...mangas, ...imported];
                            await saveData();
                            applyFilters();
                            alert(`‚úÖ ${imported.length} mangas importados desde Mihon`);
                        } else {
                            throw new Error('Formato de backup inv√°lido');
                        }
                    } catch (error) {
                        alert('‚ùå Error al importar: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function getStatusFromMihon(status) {
            const statusMap = {
                1: 'reading',
                2: 'completed',
                3: 'paused',
                5: 'dropped'
            };
            return statusMap[status] || 'reading';
        }
        
        // NUEVA FUNCIONALIDAD: HISTORIAL DE LECTURA
        function viewReadingHistory() {
            if (readingHistory.length === 0) {
                alert('No hay historial de lectura a√∫n.\n\nEmpieza a leer mangas para generar tu historial.');
                return;
            }
            
            const recent = readingHistory.slice(-20).reverse();
            let html = '<h3 style="margin-bottom: 15px;">üìñ Historial de Lectura</h3>';
            
            recent.forEach(entry => {
                const manga = mangas.find(m => m.manga_id === entry.manga_id);
                if (manga) {
                    const date = new Date(entry.date).toLocaleDateString('es-ES');
                    html += `
                        <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px;">
                            <strong>${manga.titulo_display}</strong><br>
                            <small style="color: rgba(255,255,255,0.7);">
                                üìñ Cap. ${entry.chapter} ‚Ä¢ üìÖ ${date}
                            </small>
                        </div>
                    `;
                }
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üìñ Historial</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // NUEVA FUNCIONALIDAD: MODO LECTURA R√ÅPIDA
        function quickReadMode() {
            const unread = mangas.filter(m => m.status === 'reading').slice(0, 10);
            
            if (unread.length === 0) {
                alert('No tienes mangas en progreso.\n\n¬°A√±ade algunos para usar el modo lectura r√°pida!');
                return;
            }
            
            let html = '<h3 style="margin-bottom: 15px;">‚ö° Acceso R√°pido</h3>';
            html += '<p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Tus 10 mangas en progreso:</p>';
            
            unread.forEach(manga => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px;">
                        <div>
                            <strong>${manga.titulo_display}</strong><br>
                            <small style="color: rgba(255,255,255,0.7);">üìñ Cap. ${manga.capitulo_actual}</small>
                        </div>
                        <button class="btn btn-primary" onclick="window.open('${manga.url}', '_blank'); this.closest('.modal').remove();" style="padding: 8px 16px;">
                            üìñ Leer
                        </button>
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ö° Lectura R√°pida</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // NUEVA FUNCIONALIDAD: BACKUP AUTOM√ÅTICO LOCAL
        function createAutoBackup() {
            const backup = {
                version: '5.0',
                date: new Date().toISOString(),
                mangas: mangas,
                collections: collections,
                history: readingHistory,
                stats: {
                    totalMangas: mangas.length,
                    totalChapters: mangas.reduce((sum, m) => sum + (m.capitulo_actual || 0), 0),
                    completed: mangas.filter(m => m.status === 'completed').length
                }
            };
            
            localStorage.setItem('manga-backup-auto', JSON.stringify(backup));
            console.log('‚úÖ Backup autom√°tico creado');
        }
        
        function restoreAutoBackup() {
            const backup = localStorage.getItem('manga-backup-auto');
            if (!backup) {
                alert('No hay backup autom√°tico disponible');
                return;
            }
            
            if (confirm('¬øRestaurar el √∫ltimo backup autom√°tico?\n\nEsto reemplazar√° tu biblioteca actual.')) {
                const data = JSON.parse(backup);
                mangas = data.mangas || [];
                collections = data.collections || [];
                readingHistory = data.history || [];
                
                saveData();
                applyFilters();
                alert('‚úÖ Backup restaurado correctamente');
            }
        }
        
        // NUEVA FUNCIONALIDAD: BUSCAR Y ACTUALIZAR PORTADAS
        async function updateAllCovers() {
            if (mangas.length === 0) {
                alert('No hay mangas en la biblioteca');
                return;
            }
            
            if (!confirm(`¬øBuscar y actualizar portadas para ${mangas.length} mangas?\n\nEsto puede tardar varios minutos.`)) {
                return;
            }
            
            updateSyncStatus('üîÑ Actualizando portadas...', 'info');
            let updated = 0;
            
            for (let i = 0; i < mangas.length; i++) {
                const manga = mangas[i];
                
                // Solo actualizar si no tiene portada v√°lida
                if (!manga.cover_image || manga.cover_image.includes('placeholder') || manga.cover_image.includes('ui-avatars')) {
                    try {
                        const cover = await searchMangaCover(manga.titulo);
                        manga.cover_image = cover;
                        updated++;
                        
                        // Delay para no saturar la API
                        if (i % 3 === 0) await new Promise(r => setTimeout(r, 1000));
                    } catch (error) {
                        console.log(`Error actualizando ${manga.titulo}:`, error);
                    }
                }
                
                // Actualizar progreso
                updateSyncStatus(`üîÑ ${i + 1}/${mangas.length} procesados...`, 'info');
            }
            
            await saveData();
            applyFilters();
            updateSyncStatus('‚úÖ Sincronizado', 'success');
            alert(`‚úÖ ${updated} portadas actualizadas`);
        }
        
        // NUEVA FUNCIONALIDAD: GENERAR RESUMEN IA
        async function generateLibrarySummary() {
            if (mangas.length === 0) {
                alert('A√±ade mangas primero');
                return;
            }
            
            const totalChapters = mangas.reduce((sum, m) => sum + (m.capitulo_actual || 0), 0);
            const avgRating = (mangas.reduce((sum, m) => sum + (m.rating || 0), 0) / mangas.length).toFixed(1);
            const favorites = mangas.filter(m => m.rating >= 4).map(m => m.titulo).slice(0, 5).join(', ');
            const mostReadDemo = getMostReadDemografia();
            
            const prompt = `Genera un resumen motivador y divertido (3-4 l√≠neas) sobre este lector de manga:

üìä Estad√≠sticas:
- ${mangas.length} mangas en total
- ${totalChapters} cap√≠tulos le√≠dos
- ${mangas.filter(m => m.status === 'completed').length} series completadas
- Calificaci√≥n promedio: ${avgRating}/5
- G√©nero favorito: ${mostReadDemo}
- Favoritos: ${favorites}

Hazlo personal, divertido y motivador. Incluye emojis.`;
            
            try {
                updateSyncStatus('ü§ñ Generando resumen...', 'info');
                const summary = await callGeminiAPI(prompt);
                
                alert(`ü§ñ RESUMEN DE TU BIBLIOTECA\n\n${summary}\n\nüíæ Este resumen se ha guardado en tu perfil.`);
                
                // Guardar resumen
                localStorage.setItem('library-summary', summary);
                localStorage.setItem('summary-date', new Date().toISOString());
                
                updateSyncStatus('‚úÖ Sincronizado', 'success');
            } catch (error) {
                alert('Error generando resumen: ' + error.message);
            }
        }
        
        function setupGitHubSync() {
            const instructions = `
üîê CONFIGURACI√ìN DE SINCRONIZACI√ìN EN LA NUBE

Para sincronizar tu biblioteca entre dispositivos necesitas:

1Ô∏è‚É£ Crear un GitHub Token:
   ‚Ä¢ Ve a: github.com/settings/tokens
   ‚Ä¢ Click en "Generate new token (classic)"
   ‚Ä¢ Nombre: "Manga Library Sync"
   ‚Ä¢ Permisos: Solo marca "gist"
   ‚Ä¢ Genera el token y c√≥pialo

2Ô∏è‚É£ El sistema crear√° autom√°ticamente un Gist privado

¬øQuieres configurarlo ahora?
            `;
            
            if (confirm(instructions)) {
                const token = prompt('Pega tu GitHub Token:');
                if (token && token.trim().startsWith('ghp_')) {
                    localStorage.setItem('github-token', token.trim());
                    githubToken = token.trim();
                    alert('‚úÖ Token guardado. Creando tu biblioteca en la nube...');
                    createInitialGist();
                } else {
                    alert('‚ùå Token inv√°lido. Debe empezar con "ghp_"');
                }
            }
        }
        
        async function createInitialGist() {
            if (!githubToken) return;
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: 'Manga Library - Auto Sync',
                        public: false,
                        files: {
                            'manga-library.json': {
                                content: JSON.stringify({
                                    mangas: mangas,
                                    collections: collections,
                                    history: readingHistory,
                                    lastUpdate: new Date().toISOString()
                                }, null, 2)
                            }
                        }
                    })
                });
                
                if (!response.ok) throw new Error('Error creando Gist');
                
                const data = await response.json();
                gistId = data.id;
                localStorage.setItem('gist-id', gistId);
                
                updateSyncStatus('‚úÖ Sincronizaci√≥n configurada', 'success');
                alert(`‚úÖ ¬°Listo! Tu biblioteca est√° en la nube.\n\nGist ID: ${gistId}\n\nGuarda este ID para sincronizar en otros dispositivos.`);
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al crear Gist. Verifica tu token.');
            }
        }
        
        async function syncFromCloud() {
            if (!githubToken || !gistId) {
                loadFromStorage();
                return;
            }
            
            try {
                updateSyncStatus('üîÑ Sincronizando...', 'info');
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener datos');
                }
                
                const data = await response.json();
                const content = JSON.parse(data.files['manga-library.json'].content);
                
                const localLastUpdate = localStorage.getItem('last-local-update');
                const cloudLastUpdate = content.lastUpdate;
                
                // Si la nube es m√°s reciente, actualizar local
                if (!localLastUpdate || new Date(cloudLastUpdate) > new Date(localLastUpdate)) {
                    mangas = content.mangas || [];
                    collections = content.collections || [];
                    readingHistory = content.history || [];
                    
                    localStorage.setItem('manga-library', JSON.stringify(mangas));
                    localStorage.setItem('manga-collections', JSON.stringify(collections));
                    localStorage.setItem('reading-history', JSON.stringify(readingHistory));
                    localStorage.setItem('last-local-update', cloudLastUpdate);
                    
                    console.log('üì• Datos actualizados desde la nube');
                    updateSyncStatus('‚úÖ Sincronizado', 'success');
                } else {
                    // Si local es m√°s reciente, subir a la nube
                    await syncToCloud();
                }
                
                applyFilters();
                
            } catch (error) {
                console.error('Error de sincronizaci√≥n:', error);
                updateSyncStatus('‚ö†Ô∏è Error de sync', 'error');
                loadFromStorage();
            }
        }
        
        async function syncToCloud() {
            if (!githubToken || !gistId) return;
            
            try {
                const now = new Date().toISOString();
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        files: {
                            'manga-library.json': {
                                content: JSON.stringify({
                                    mangas: mangas,
                                    collections: collections,
                                    history: readingHistory,
                                    lastUpdate: now
                                }, null, 2)
                            }
                        }
                    })
                });
                
                if (!response.ok) throw new Error('Error actualizando Gist');
                
                localStorage.setItem('last-local-update', now);
                console.log('üì§ Datos subidos a la nube');
                updateSyncStatus('‚úÖ Sincronizado', 'success');
                
            } catch (error) {
                console.error('Error subiendo datos:', error);
                updateSyncStatus('‚ö†Ô∏è Error al subir', 'error');
            }
        }
        
        function updateSyncStatus(text, type) {
            const statusEl = document.getElementById('syncStatus');
            if (!statusEl) return;
            
            const colors = {
                success: 'rgba(16, 185, 129, 0.3)',
                error: 'rgba(239, 68, 68, 0.3)',
                info: 'rgba(59, 130, 246, 0.3)'
            };
            
            statusEl.textContent = text;
            statusEl.style.background = colors[type] || colors.info;
            statusEl.style.borderColor = colors[type]?.replace('0.3', '0.5') || colors.info.replace('0.3', '0.5');
        }
        
        async function importFromAnotherDevice() {
            const inputGistId = prompt('Ingresa el Gist ID de otro dispositivo:');
            if (!inputGistId) return;
            
            const inputToken = prompt('Ingresa tu GitHub Token:');
            if (!inputToken) return;
            
            localStorage.setItem('github-token', inputToken.trim());
            localStorage.setItem('gist-id', inputGistId.trim());
            githubToken = inputToken.trim();
            gistId = inputGistId.trim();
            
            await syncFromCloud();
            alert('‚úÖ Biblioteca importada desde otro dispositivo');
        }
        
        function showSyncInfo() {
            if (!gistId) {
                alert('No hay sincronizaci√≥n configurada.\n\nConfig√∫rala desde el header.');
                return;
            }
            
            const info = `
üì± INFORMACI√ìN DE SINCRONIZACI√ìN

üÜî Gist ID: ${gistId}
üîó URL: https://gist.github.com/${gistId}

Para sincronizar en otro dispositivo:
1. Abre la biblioteca en el otro dispositivo
2. Click en "‚öôÔ∏è Configurar sync"
3. Ingresa el mismo token y este Gist ID

üîÑ Auto-sync: Cada 2 minutos
üíæ √öltima actualizaci√≥n: ${localStorage.getItem('last-local-update') || 'Nunca'}
            `;
            
            alert(info);
        }
        
        function resetSync() {
            if (confirm('‚ö†Ô∏è ¬øEliminar configuraci√≥n de sincronizaci√≥n?\n\nTus datos locales NO se borrar√°n.')) {
                localStorage.removeItem('github-token');
                localStorage.removeItem('gist-id');
                localStorage.removeItem('last-local-update');
                githubToken = null;
                gistId = null;
                
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
                
                updateSyncStatus('‚ö†Ô∏è Sync desactivado', 'error');
                alert('‚úÖ Configuraci√≥n de sincronizaci√≥n eliminada');
            }
        }
        
        async function loadData() {
            try {
                const data = localStorage.getItem('manga-library');
                const collectionsData = localStorage.getItem('manga-collections');
                const historyData = localStorage.getItem('reading-history');
                
                if (data) mangas = JSON.parse(data);
                if (collectionsData) collections = JSON.parse(collectionsData);
                if (historyData) readingHistory = JSON.parse(historyData);
                
                applyFilters();
            } catch (e) {
                console.error('Error al cargar:', e);
            }
        }
        
        async function saveData() {
            try {
                localStorage.setItem('manga-library', JSON.stringify(mangas));
                localStorage.setItem('manga-collections', JSON.stringify(collections));
                localStorage.setItem('reading-history', JSON.stringify(readingHistory));
                updateAllStats();
                
                // Sincronizar autom√°ticamente con la nube
                if (githubToken && gistId) {
                    await syncToCloud();
                }
            } catch (e) {
                console.error('Error al guardar:', e);
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'estadisticas') renderStatistics();
            if (tabName === 'ia') generateAIRecommendations();
            if (tabName === 'colecciones') renderCollections();
        }
        
        function updateAllStats() {
            document.getElementById('totalMangas').textContent = mangas.length;
            document.getElementById('totalChapters').textContent = mangas.reduce((sum, m) => sum + (m.capitulo_actual || 0), 0);
            document.getElementById('completedMangas').textContent = mangas.filter(m => m.status === 'completed').length;
            document.getElementById('readingStreak').textContent = calculateReadingStreak();
            updateDemografiaFilter();
        }
        
        function calculateReadingStreak() {
            if (!readingHistory.length) return 0;
            const dates = readingHistory.map(h => new Date(h.date).toDateString());
            let streak = 1;
            const today = new Date().toDateString();
            
            if (!dates.includes(today)) return 0;
            
            for (let i = 1; i < 30; i++) {
                const checkDate = new Date(Date.now() - i * 24 * 60 * 60 * 1000).toDateString();
                if (dates.includes(checkDate)) streak++;
                else break;
            }
            return streak;
        }
        
        async function searchMangaCover(titulo) {
            try {
                const response = await fetch(`${JIKAN_API}/manga?q=${encodeURIComponent(titulo)}&limit=1`);
                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                if (data.data && data.data.length > 0) {
                    return data.data[0].images.jpg.large_image_url || data.data[0].images.jpg.image_url;
                }
            } catch (error) {
                console.log('Error buscando portada:', error);
            }
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(titulo.substring(0, 30))}&size=400&background=random&bold=true&length=2`;
        }
        
        // FILTROS
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('filterDemografia').addEventListener('change', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterRating').addEventListener('change', applyFilters);
        
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const demografia = document.getElementById('filterDemografia').value;
            const status = document.getElementById('filterStatus').value;
            const rating = document.getElementById('filterRating').value;
            
            let filtered = mangas.filter(manga => {
                const matchSearch = !search || manga.titulo.toLowerCase().includes(search);
                const matchDemografia = !demografia || manga.demografia === demografia;
                const matchStatus = status === 'all' || manga.status === status;
                const matchRating = rating === 'all' || (manga.rating || 0) >= parseInt(rating);
                
                return matchSearch && matchDemografia && matchStatus && matchRating;
            });
            
            renderMangas(filtered);
        }
        
        function updateDemografiaFilter() {
            const select = document.getElementById('filterDemografia');
            const demografias = [...new Set(mangas.map(m => m.demografia).filter(Boolean))].sort();
            
            select.innerHTML = '<option value="">üìö Todas</option>';
            demografias.forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                select.appendChild(option);
            });
        }
        
        function renderMangas(filtered) {
            const grid = document.getElementById('mangaGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><h2>No se encontraron mangas</h2></div>';
                return;
            }
            
            grid.innerHTML = filtered.map((manga) => {
                const stars = renderStars(manga.rating || 0);
                const tags = (manga.tags || []).slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('');
                const statusIcon = getStatusIcon(manga.status);
                
                return `
                <div class="manga-card">
                    <div style="position: relative;">
                        <img src="${manga.cover_image}" alt="${manga.titulo}" 
                            onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(manga.titulo.substring(0, 30))}&size=400&background=random'">
                        ${manga.en_mihon ? '<span class="badge">üì± Mihon</span>' : ''}
                        ${statusIcon ? `<span class="badge" style="top: 50px;">${statusIcon}</span>` : ''}
                    </div>
                    <div class="manga-info">
                        <div class="manga-title">${manga.titulo_display}</div>
                        <div class="rating-stars">${stars}</div>
                        <div class="manga-details">
                            ${manga.demografia ? `üìö ${manga.demografia}<br>` : ''}
                            üìñ Cap. ${manga.capitulo_actual || 0}${manga.capitulo_total ? `/${manga.capitulo_total}` : ''}
                        </div>
                        <div class="manga-tags">${tags}</div>
                        <div class="manga-actions">
                            <button class="btn-read" onclick="readManga(${mangas.indexOf(manga)})" title="Leer ahora">üìñ</button>
                            <button class="btn-edit" onclick="openEditModal(${mangas.indexOf(manga)})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="deleteManga(${mangas.indexOf(manga)})" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        function renderStars(rating) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += `<span class="star ${i <= rating ? 'filled' : 'empty'}">‚òÖ</span>`;
            }
            return html;
        }
        
        function getStatusIcon(status) {
            const icons = {
                'reading': 'üìñ',
                'completed': '‚úÖ',
                'paused': '‚è∏Ô∏è',
                'dropped': '‚ùå'
            };
            return icons[status] || '';
        }
        
        function readManga(index) {
            const manga = mangas[index];
            if (manga.url) {
                window.open(manga.url, '_blank');
                
                // Registrar en historial
                readingHistory.push({
                    manga_id: manga.manga_id,
                    date: new Date().toISOString(),
                    chapter: manga.capitulo_actual
                });
                saveData();
            } else {
                alert('Este manga no tiene URL configurada');
            }
        }
        
        // A√ëADIR MANGA
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }
        
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('newMangaUrl').value = '';
            document.getElementById('newMangaChapter').value = '0';
        }
        
        async function addManga() {
            const url = document.getElementById('newMangaUrl').value.trim();
            const chapter = parseInt(document.getElementById('newMangaChapter').value) || 0;
            
            if (!url) {
                alert('Por favor ingresa una URL');
                return;
            }
            
            document.getElementById('addBtnText').innerHTML = 'üîÑ Buscando...';
            
            let mangaId = Date.now().toString();
            const idMatch = url.match(/\/manga\/(\d+)/) || url.match(/\/(\d+)\//);
            if (idMatch) mangaId = idMatch[1];
            
            let titulo = 'Manga sin t√≠tulo';
            const patterns = [/\/manga\/([^\/\?]+)\/?$/, /\/manga\/\d+\/([^\/\?]+)/, /\/([^\/\?]+)\/?$/];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1] && !match[1].match(/^\d+$/)) {
                    titulo = match[1];
                    break;
                }
            }
            
            titulo = titulo.replace(/[-_]/g, ' ').replace(/\+/g, ' ')
                .split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ').trim();
            
            const cover = await searchMangaCover(titulo);
            
            const newManga = {
                url: url,
                manga_id: mangaId,
                cover_image: cover,
                titulo: titulo,
                titulo_display: titulo,
                demografia: '',
                capitulo_actual: chapter,
                capitulo_total: 0,
                status: 'reading',
                rating: 0,
                tags: [],
                notes: '',
                en_mihon: false,
                fecha_agregado: new Date().toISOString()
            };
            
            mangas.push(newManga);
            await saveData();
            applyFilters();
            closeAddModal();
            alert(`‚úÖ "${titulo}" a√±adido correctamente`);
        }
        
        // EDITAR MANGA
        function openEditModal(index) {
            currentEditIndex = index;
            const manga = mangas[index];
            
            document.getElementById('editTitle').value = manga.titulo_display;
            document.getElementById('editChapter').value = manga.capitulo_actual || 0;
            document.getElementById('editTotalChapter').value = manga.capitulo_total || 0;
            document.getElementById('editStatus').value = manga.status || 'reading';
            document.getElementById('editDemografia').value = manga.demografia || '';
            document.getElementById('editTags').value = (manga.tags || []).join(', ');
            document.getElementById('editNotes').value = manga.notes || '';
            document.getElementById('editCover').value = manga.cover_image || '';
            document.getElementById('editMihon').checked = manga.en_mihon || false;
            
            renderEditRatingStars(manga.rating || 0);
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function renderEditRatingStars(currentRating) {
            const container = document.getElementById('editRatingStars');
            container.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = `star ${i <= currentRating ? 'filled' : 'empty'}`;
                star.textContent = '‚òÖ';
                star.onclick = () => {
                    renderEditRatingStars(i);
                };
                container.appendChild(star);
            }
            container.dataset.rating = currentRating;
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditIndex = -1;
        }
        
        async function saveEdit() {
            if (currentEditIndex === -1) return;
            
            const ratingContainer = document.getElementById('editRatingStars');
            const tagsInput = document.getElementById('editTags').value;
            
            mangas[currentEditIndex].titulo_display = document.getElementById('editTitle').value;
            mangas[currentEditIndex].titulo = document.getElementById('editTitle').value;
            mangas[currentEditIndex].capitulo_actual = parseInt(document.getElementById('editChapter').value) || 0;
            mangas[currentEditIndex].capitulo_total = parseInt(document.getElementById('editTotalChapter').value) || 0;
            mangas[currentEditIndex].status = document.getElementById('editStatus').value;
            mangas[currentEditIndex].demografia = document.getElementById('editDemografia').value;
            mangas[currentEditIndex].rating = parseInt(ratingContainer.dataset.rating) || 0;
            mangas[currentEditIndex].tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(Boolean) : [];
            mangas[currentEditIndex].notes = document.getElementById('editNotes').value;
            mangas[currentEditIndex].cover_image = document.getElementById('editCover').value;
            mangas[currentEditIndex].en_mihon = document.getElementById('editMihon').checked;
            
            await saveData();
            applyFilters();
            closeEditModal();
            alert('‚úÖ Cambios guardados');
        }
        
        function deleteManga(index) {
            if (confirm(`¬øEliminar "${mangas[index].titulo}"?`)) {
                mangas.splice(index, 1);
                saveData();
                applyFilters();
            }
        }
        
        // SUGERENCIA ALEATORIA
        function suggestRandomManga() {
            const unreadMangas = mangas.filter(m => m.status !== 'completed');
            if (unreadMangas.length === 0) {
                alert('¬°Ya completaste todos tus mangas! üéâ');
                return;
            }
            
            const random = unreadMangas[Math.floor(Math.random() * unreadMangas.length)];
            const stars = '‚≠ê'.repeat(random.rating || 3);
            
            alert(`üé≤ Sugerencia del d√≠a:\n\nüìö ${random.titulo_display}\n${stars}\nüìñ Cap. ${random.capitulo_actual}/${random.capitulo_total || '?'}\n\n${random.notes || '¬°Es hora de continuar esta aventura!'}`);
        }
        
        // DUPLICADOS
        async function removeDuplicates() {
            const before = mangas.length;
            const seen = new Map();
            
            mangas = mangas.filter(manga => {
                const key = manga.titulo.toLowerCase().trim();
                if (seen.has(key)) return false;
                seen.set(key, true);
                return true;
            });
            
            const removed = before - mangas.length;
            if (removed > 0) {
                await saveData();
                applyFilters();
                alert(`‚úÖ ${removed} duplicados eliminados`);
            } else {
                alert('‚ÑπÔ∏è No hay duplicados');
            }
        }
        
        // IMPORTAR/EXPORTAR
        async function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    let jsonText = e.target.result;
                    jsonText = jsonText.replace(/:\s*NaN\s*([,\}])/g, ': null$1').replace(/NaN/g, 'null');
                    
                    const json = JSON.parse(jsonText);
                    let imported = json.biblioteca || json;
                    
                    if (!Array.isArray(imported)) throw new Error('Formato inv√°lido');
                    
                    mangas = imported.map(manga => ({
                        ...manga,
                        status: manga.status || (manga.completado ? 'completed' : 'reading'),
                        rating: manga.rating || 0,
                        tags: manga.tags || [],
                        notes: manga.notes || '',
                        capitulo_actual: parseInt(manga.capitulo_actual) || 0,
                        capitulo_total: parseInt(manga.capitulo_total) || 0
                    }));
                    
                    // Eliminar duplicados
                    const seen = new Map();
                    mangas = mangas.filter(manga => {
                        const key = manga.titulo.toLowerCase().trim();
                        if (seen.has(key)) return false;
                        seen.set(key, true);
                        return true;
                    });
                    
                    await saveData();
                    applyFilters();
                    alert(`‚úÖ ${mangas.length} mangas importados`);
                } catch (error) {
                    alert('‚ùå Error: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function exportJSON() {
            if (mangas.length === 0) {
                alert('No hay mangas para exportar');
                return;
            }
            
            const data = {
                metadata: {
                    fecha_exportacion: new Date().toISOString(),
                    total_mangas: mangas.length,
                    version: '5.0'
                },
                biblioteca: mangas
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `biblioteca_manga_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ESTAD√çSTICAS
        function renderStatistics() {
            renderDemografiaChart();
            renderProgressChart();
            renderTopMangas();
        }
        
        function renderDemografiaChart() {
            const demografias = {};
            mangas.forEach(m => {
                const demo = m.demografia || 'Sin clasificar';
                demografias[demo] = (demografias[demo] || 0) + 1;
            });
            
            let html = '';
            Object.entries(demografias).forEach(([demo, count]) => {
                const percent = (count / mangas.length * 100).toFixed(1);
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${demo}</span>
                            <span>${count} (${percent}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('demografiaChart').innerHTML = html;
        }
        
        function renderProgressChart() {
            const reading = mangas.filter(m => m.status === 'reading').length;
            const completed = mangas.filter(m => m.status === 'completed').length;
            const paused = mangas.filter(m => m.status === 'paused').length;
            const dropped = mangas.filter(m => m.status === 'dropped').length;
            
            const total = mangas.length || 1;
            
            document.getElementById('progressChart').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>üìñ Leyendo</span>
                        <span>${reading} (${(reading/total*100).toFixed(1)}%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${reading/total*100}%; background: linear-gradient(90deg, #3b82f6, #2563eb);"></div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>‚úÖ Completados</span>
                        <span>${completed} (${(completed/total*100).toFixed(1)}%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${completed/total*100}%; background: linear-gradient(90deg, #10b981, #059669);"></div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>‚è∏Ô∏è En pausa</span>
                        <span>${paused} (${(paused/total*100).toFixed(1)}%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${paused/total*100}%; background: linear-gradient(90deg, #f59e0b, #d97706);"></div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>‚ùå Abandonados</span>
                        <span>${dropped} (${(dropped/total*100).toFixed(1)}%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${dropped/total*100}%; background: linear-gradient(90deg, #ef4444, #dc2626);"></div>
                    </div>
                </div>
            `;
        }
        
        function renderTopMangas() {
            const sorted = [...mangas].sort((a, b) => (b.capitulo_actual || 0) - (a.capitulo_actual || 0)).slice(0, 10);
            
            let html = '';
            sorted.forEach((manga, i) => {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px;">
                        <span>${i + 1}. ${manga.titulo_display}</span>
                        <span>üìñ ${manga.capitulo_actual} caps</span>
                    </div>
                `;
            });
            
            document.getElementById('topMangasChart').innerHTML = html;
        }
        
        // IA ASISTENTE
        function generateAIRecommendations() {
            if (mangas.length === 0) {
                document.getElementById('aiRecommendation').textContent = 'A√±ade mangas a tu biblioteca para recibir recomendaciones personalizadas.';
                return;
            }
            
            // An√°lisis simple basado en patrones
            const demografias = {};
            const topRated = mangas.filter(m => m.rating >= 4).slice(0, 3);
            
            mangas.forEach(m => {
                if (m.demografia) demografias[m.demografia] = (demografias[m.demografia] || 0) + 1;
            });
            
            const favDemo = Object.entries(demografias).sort((a, b) => b[1] - a[1])[0];
            
            let recommendation = `üìä An√°lisis de tu biblioteca:\n\n`;
            recommendation += `‚Ä¢ Tienes ${mangas.length} mangas en total\n`;
            recommendation += `‚Ä¢ Tu g√©nero favorito parece ser: ${favDemo ? favDemo[0] : 'variado'}\n`;
            recommendation += `‚Ä¢ Has le√≠do ${mangas.reduce((sum, m) => sum + (m.capitulo_actual || 0), 0)} cap√≠tulos\n\n`;
            
            if (topRated.length > 0) {
                recommendation += `üåü Tus favoritos:\n`;
                topRated.forEach(m => {
                    recommendation += `‚Ä¢ ${m.titulo_display} (${'‚≠ê'.repeat(m.rating)})\n`;
                });
            }
            
            document.getElementById('aiRecommendation').textContent = recommendation;
            
            // An√°lisis de preferencias
            renderPreferencesAnalysis();
        }
        
        function renderPreferencesAnalysis() {
            const avgRating = mangas.length > 0 
                ? (mangas.reduce((sum, m) => sum + (m.rating || 0), 0) / mangas.length).toFixed(1)
                : 0;
            
            const readingSpeed = mangas.length > 0
                ? (mangas.reduce((sum, m) => sum + (m.capitulo_actual || 0), 0) / mangas.length).toFixed(1)
                : 0;
            
            const completionRate = mangas.length > 0 
                ? ((mangas.filter(m => m.status === 'completed').length / mangas.length) * 100).toFixed(1)
                : 0;
            
            document.getElementById('preferencesAnalysis').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>‚≠ê Calificaci√≥n promedio:</strong> ${avgRating}/5
                    <div class="progress-bar" style="margin-top: 5px;">
                        <div class="progress-fill" style="width: ${avgRating * 20}%; background: linear-gradient(90deg, #fbbf24, #f59e0b);"></div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>üìñ Cap√≠tulos promedio:</strong> ${readingSpeed} por manga
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>üéØ Tasa de completado:</strong> ${completionRate}%
                    <div class="progress-bar" style="margin-top: 5px;">
                        <div class="progress-fill" style="width: ${completionRate}%; background: linear-gradient(90deg, #10b981, #059669);"></div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(139, 92, 246, 0.2); border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.3);">
                    <strong>ü§ñ An√°lisis IA:</strong><br>
                    <span id="aiAnalysisText">Generando an√°lisis personalizado...</span>
                </div>
            `;
            
            // Generar an√°lisis con IA
            generatePersonalizedAnalysis();
        }
        
        async function generatePersonalizedAnalysis() {
            if (mangas.length === 0) return;
            
            const favorites = mangas.filter(m => m.rating >= 4).map(m => m.titulo).slice(0, 3);
            const mostReadDemo = getMostReadDemografia();
            
            const prompt = `Como experto en manga, analiza este perfil de lector en 2-3 l√≠neas:
- Ha le√≠do ${mangas.length} mangas
- Sus favoritos son: ${favorites.join(', ')}
- Lee principalmente: ${mostReadDemo}
- Ha completado ${mangas.filter(m => m.status === 'completed').length} series

Dale un consejo breve y motivador.`;
            
            try {
                const analysis = await callGeminiAPI(prompt);
                document.getElementById('aiAnalysisText').textContent = analysis;
            } catch (error) {
                document.getElementById('aiAnalysisText').textContent = 
                    `Bas√°ndome en tus gustos, te recomiendo explorar m√°s t√≠tulos de ${mostReadDemo}. ¬°Sigue leyendo! üìö`;
            }
        }
        
        function getMostReadDemografia() {
            const demografias = {};
            mangas.forEach(m => {
                if (m.demografia) demografias[m.demografia] = (demografias[m.demografia] || 0) + 1;
            });
            const sorted = Object.entries(demografias).sort((a, b) => b[1] - a[1]);
            return sorted[0] ? sorted[0][0] : 'varios g√©neros';
        }
        
        function askAI() {
            const query = document.getElementById('aiQuery').value.trim();
            if (!query) {
                alert('Por favor escribe una pregunta');
                return;
            }
            
            // Simulaci√≥n de respuesta IA (aqu√≠ podr√≠as integrar Claude API)
            const response = generateAIResponse(query);
            document.getElementById('aiResponseText').textContent = response;
            document.getElementById('aiResponse').style.display = 'block';
        }
        
        function generateAIResponse(query) {
            query = query.toLowerCase();
            
            // Respuestas basadas en patrones simples
            if (query.includes('recomendar') || query.includes('leer')) {
                const unread = mangas.filter(m => m.status === 'reading' && m.capitulo_actual < (m.capitulo_total || 999));
                if (unread.length > 0) {
                    const random = unread[Math.floor(Math.random() * unread.length)];
                    return `Te recomiendo continuar con "${random.titulo_display}". Vas por el cap√≠tulo ${random.capitulo_actual} y tiene muy buena pinta! üìö`;
                }
            }
            
            if (query.includes('estad√≠stica') || query.includes('cu√°nto')) {
                return `Tienes ${mangas.length} mangas en total, has le√≠do ${mangas.reduce((sum, m) => sum + (m.capitulo_actual || 0), 0)} cap√≠tulos, y has completado ${mangas.filter(m => m.status === 'completed').length} series. ¬°Sigue as√≠! üî•`;
            }
            
            // Respuesta gen√©rica
            return `Para obtener respuestas m√°s inteligentes, puedes integrar la API de Claude AI. Esta es una versi√≥n simulada que analiza patrones en tu biblioteca. ü§ñ\n\nTu pregunta: "${query}"\n\nAn√°lisis: Bas√°ndome en tus ${mangas.length} mangas, te sugiero explorar m√°s t√≠tulos de ${mangas[0]?.demografia || 'diversos g√©neros'}.`;
        }
        
        // DESCUBRIR (buscar en MAL)
        async function searchTrending() {
            try {
                const response = await fetch(`${JIKAN_API}/top/manga?filter=bypopularity&limit=12`);
                const data = await response.json();
                renderDiscoverResults(data.data);
            } catch (error) {
                alert('Error al buscar trending: ' + error.message);
            }
        }
        
        async function searchPopular() {
            try {
                const response = await fetch(`${JIKAN_API}/top/manga?limit=12`);
                const data = await response.json();
                renderDiscoverResults(data.data);
            } catch (error) {
                alert('Error al buscar populares: ' + error.message);
            }
        }
        
        async function searchRecommended() {
            // Basado en tus mangas actuales
            if (mangas.length === 0) {
                alert('A√±ade mangas primero para recibir recomendaciones');
                return;
            }
            
            const randomManga = mangas[Math.floor(Math.random() * mangas.length)];
            try {
                const response = await fetch(`${JIKAN_API}/manga/${randomManga.manga_id}/recommendations`);
                const data = await response.json();
                if (data.data && data.data.length > 0) {
                    const recommendations = data.data.map(r => r.entry).slice(0, 12);
                    renderDiscoverResults(recommendations);
                } else {
                    alert('No se encontraron recomendaciones');
                }
            } catch (error) {
                searchPopular(); // Fallback
            }
        }
        
        async function searchNewMangas() {
            const query = document.getElementById('searchNewManga').value.trim();
            if (!query) {
                alert('Escribe algo para buscar');
                return;
            }
            
            try {
                const response = await fetch(`${JIKAN_API}/manga?q=${encodeURIComponent(query)}&limit=12`);
                const data = await response.json();
                renderDiscoverResults(data.data);
            } catch (error) {
                alert('Error en la b√∫squeda: ' + error.message);
            }
        }
        
        function renderDiscoverResults(results) {
            const grid = document.getElementById('discoverGrid');
            
            if (!results || results.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center;">No se encontraron resultados</div>';
                return;
            }
            
            grid.innerHTML = results.map(manga => `
                <div class="manga-card">
                    <div style="position: relative;">
                        <img src="${manga.images?.jpg?.large_image_url || manga.images?.jpg?.image_url}" alt="${manga.title}">
                    </div>
                    <div class="manga-info">
                        <div class="manga-title">${manga.title}</div>
                        <div class="manga-details">
                            ‚≠ê ${manga.score || 'N/A'}/10<br>
                            üìö ${manga.type || 'Manga'}
                        </div>
                        <button class="btn btn-primary" onclick="quickAddFromDiscover('${manga.title.replace(/'/g, "\\'")}', '${(manga.images?.jpg?.large_image_url || manga.images?.jpg?.image_url).replace(/'/g, "\\'")}', '${manga.mal_id}')" style="width: 100%;">
                            ‚ûï A√±adir a biblioteca
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        async function quickAddFromDiscover(title, coverUrl, malId) {
            const newManga = {
                url: `https://myanimelist.net/manga/${malId}`,
                manga_id: malId,
                cover_image: coverUrl,
                titulo: title,
                titulo_display: title,
                demografia: '',
                capitulo_actual: 0,
                capitulo_total: 0,
                status: 'reading',
                rating: 0,
                tags: [],
                notes: '',
                en_mihon: false,
                fecha_agregado: new Date().toISOString()
            };
            
            mangas.push(newManga);
            await saveData();
            alert(`‚úÖ "${title}" a√±adido a tu biblioteca`);
        }
        
        // COLECCIONES
        function renderCollections() {
            const grid = document.getElementById('collectionsGrid');
            
            if (collections.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1/-1;">
                        <h3>No tienes colecciones a√∫n</h3>
                        <p style="margin-top: 10px;">Crea colecciones personalizadas para organizar tus mangas</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = collections.map((collection, index) => {
                const mangasInCollection = mangas.filter(m => collection.manga_ids.includes(m.manga_id));
                return `
                    <div class="chart-container">
                        <h3>${collection.icon} ${collection.name}</h3>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">${collection.description}</p>
                        <p style="margin-bottom: 10px;">üìö ${mangasInCollection.length} mangas</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="viewCollection(${index})" style="flex: 1;">
                                üëÅÔ∏è Ver
                            </button>
                            <button class="btn btn-danger" onclick="deleteCollection(${index})">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function createCollection() {
            const name = prompt('Nombre de la colecci√≥n:');
            if (!name) return;
            
            const description = prompt('Descripci√≥n (opcional):');
            const icon = prompt('Emoji para la colecci√≥n (ej: üî•, ‚≠ê, üíé):', 'üìÅ');
            
            collections.push({
                id: Date.now().toString(),
                name: name,
                description: description || '',
                icon: icon || 'üìÅ',
                manga_ids: [],
                created: new Date().toISOString()
            });
            
            saveData();
            renderCollections();
            alert(`‚úÖ Colecci√≥n "${name}" creada`);
        }
        
        function viewCollection(index) {
            const collection = collections[index];
            const mangasInCollection = mangas.filter(m => collection.manga_ids.includes(m.manga_id));
            
            if (mangasInCollection.length === 0) {
                alert(`La colecci√≥n "${collection.name}" est√° vac√≠a. A√±ade mangas edit√°ndolos y agreg√°ndolos a esta colecci√≥n.`);
                return;
            }
            
            switchTab('biblioteca');
            document.getElementById('searchInput').value = '';
            renderMangas(mangasInCollection);
        }
        
        function deleteCollection(index) {
            if (confirm(`¬øEliminar la colecci√≥n "${collections[index].name}"?`)) {
                collections.splice(index, 1);
                saveData();
                renderCollections();
            }
        }
    </script>
</body>
</html>
